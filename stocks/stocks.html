<meta charset="UTF-8"> 
<html>
	<head>
		<title>
			Stocks
		</title>
		<link rel="stylesheet" type="text/css" href="stocks.css">
		<script type="text/javascript">
			function init() {
				//stuff to interact with the canvas
				canvas = document.getElementById("graph");
				window.addEventListener("keydown", buySellKeyPress, false);
				canvasWidth = canvas.width - 100;
				canvasHeight = canvas.height
				ctx = canvas.getContext("2d");
				//game variables
				currentCost = 100;
				money = 500;
				stocks = 1;
				exchangeRates = {"dollar": 1,
								 "euro": 2,
								 "pound": 0.6,
								 "yen": 100};
				currentCurrency = ["euro", "€"];
				load();
				//populate graph array
				graphResolution = 2; //lower is more
				graph = []
				for (var n = 0; n < Math.floor(canvasWidth / graphResolution); n++) {
					graph.push(currentCost);
				}
				//start the game
				updateDisplay();
				setInterval(currencyMarketValues, 2000);
				graphTick();
			}

			function nameToSymbol(name) {
				return {"dollar": "$", "euro": "€", "pound": "£", "yen": "¥"}[name];
			}

			function currencyRate(firstCurrency, secondCurrency) {
				return (exchangeRates[secondCurrency] / exchangeRates[firstCurrency]);
			}

			function save() {
				var gameState = {"currentCost": currentCost,
								 "money": money,
								 "stocks": stocks,
								 "exchangeRates": exchangeRates,
								 "currentCurrency": currentCurrency};
				localStorage.setItem("gameState", JSON.stringify(gameState));
			}

			function load() {
				var gameState = JSON.parse(localStorage.getItem("gameState"));
				if (gameState != null) { //if we've saved before, aka not null
					//actually load stuff
					currentCost = gameState["currentCost"];
					money = gameState["money"];
					stocks = gameState["stocks"];
					exchangeRates = gameState["exchangeRates"];
					currrentCurrency = gameState["currrentCurrency"];
					//pretty status messages
					document.getElementById("gameLoaded").innerHTML += JSON.stringify(gameState);
					flash("gameLoaded");
				} else {
					document.getElementById("gameLoaded").innerHTML = "No previous saved game!";
				}
				updateDisplay();
			}

			function convertToCurrency(currency) {
				if (exchangeRates[currency] != null) {
					money = money * currencyRate(currentCurrency[0], currency);
					currentCurrency = [currency, nameToSymbol(currency)];
				}
				updateDisplay();
			}

			function currencyMarketValues() {
				//iterate through the currencies
				for (var currencyName in exchangeRates) {
					if (exchangeRates.hasOwnProperty(currencyName)) {
						//random chance to change exchange rate
						if (Math.random() < 0.3) {
							exchangeRates[currencyName] += (Math.random(0.3) - 0.15);
							if (exchangeRates[currencyName] < 0.05) {
								exchangeRates[currencyName] = 0.05;
							}
							save();
							updateDisplay();
						}
					}
				}
			}

			function graphTick() {
				//first clear canvas
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				//draw graph lines
				ctx.lineWidth = 1;
				ctx.font = "1em serif";
				for (var y = 0; y <= 20; y++) {
					ctx.strokeStyle = "#555555";
					var yPos = (y / 20) * canvasHeight;
					ctx.beginPath();
					ctx.moveTo(0, yPos);
					ctx.lineTo(canvasWidth, yPos);
					ctx.stroke();
					ctx.closePath();
					//draw money texts
					ctx.strokeStyle = "#FFFFFF";
					//look out for magic numbers - for alignment ofc
					ctx.fillText(currentCurrency[1] + yPos, canvasWidth + 10, canvasHeight - yPos / 1.018);
				}
				//draw and change the stock market line
				//first, do some logic with the cost itself
				currentCost += (Math.random() * 16) - 8;
				if (currentCost > canvasHeight) {
					currentCost -= 200;
				} else if (currentCost < 0) {
					currentCost += 200;
				}
				graph.push(currentCost);
				graph.shift();
				//then draw the graph
				ctx.strokeStyle = "#FF0000";
				ctx.lineWidth = 3;
				for (var graphIndex = 0; graphIndex < graph.length - 1; graphIndex++) {
					ctx.beginPath();
					ctx.moveTo(graphIndex * graphResolution, canvasHeight - graph[graphIndex]);
					ctx.lineTo((graphIndex * graphResolution) + graphResolution, canvasHeight - graph[graphIndex + 1]);
					ctx.stroke();
					ctx.closePath();
				}
				//call this function again
				window.requestAnimationFrame(graphTick);
			}

			function flash(id) {
				var status = document.getElementById(id);
				status.style.display = "block"
				window.setTimeout(function(){status.style.display = "none"}, 3000);
			}

			function updateDisplay() {
				//hardcoding is _fun_
				document.getElementById("moneyDisplay").innerHTML = "Money: " + currentCurrency[1] + money.toFixed(2);
				document.getElementById("stocksDisplay").innerHTML = "Stocks: " + stocks;
				document.getElementById("toDollar").innerHTML = "Convert to Dollars. Current exchange rate: " + currentCurrency[1] + "1.00 = " + nameToSymbol("dollar") + currencyRate(currentCurrency[0], "dollar").toFixed(2);
				document.getElementById("toEuro").innerHTML = "Convert to Euros. Current exchange rate: " + currentCurrency[1] + "1.00 = " + nameToSymbol("euro") + currencyRate(currentCurrency[0], "euro").toFixed(2);
				document.getElementById("toPound").innerHTML = "Convert to Pounds. Current exchange rate: " + currentCurrency[1] + "1.00 = " + nameToSymbol("pound") + currencyRate(currentCurrency[0], "pound").toFixed(2);
				document.getElementById("toYen").innerHTML = "Convert to Yen. Current exchange rate: " + currentCurrency[1] + "1.00 = " + nameToSymbol("yen") + currencyRate(currentCurrency[0], "yen").toFixed(2);
				document.getElementById("unadjustedEuro").innerHTML = exchangeRates["euro"].toFixed(2);
				document.getElementById("euroEuro").innerHTML = currencyRate("euro", "euro").toFixed(2);
				document.getElementById("dollarEuro").innerHTML = currencyRate("dollar", "euro").toFixed(2);
				document.getElementById("poundEuro").innerHTML = currencyRate("pound", "euro").toFixed(2);
				document.getElementById("yenEuro").innerHTML = currencyRate("yen", "euro").toFixed(2);
				document.getElementById("unadjustedDollar").innerHTML = exchangeRates["dollar"].toFixed(2);
				document.getElementById("euroDollar").innerHTML = currencyRate("euro", "dollar").toFixed(2);
				document.getElementById("dollarDollar").innerHTML = currencyRate("dollar", "dollar").toFixed(2);
				document.getElementById("poundDollar").innerHTML = currencyRate("pound", "dollar").toFixed(2);
				document.getElementById("yenDollar").innerHTML = currencyRate("yen", "dollar").toFixed(2);
				document.getElementById("unadjustedPound").innerHTML = exchangeRates["pound"].toFixed(2);
				document.getElementById("euroPound").innerHTML = currencyRate("euro", "pound").toFixed(2);
				document.getElementById("dollarPound").innerHTML = currencyRate("dollar", "pound").toFixed(2);
				document.getElementById("poundPound").innerHTML = currencyRate("pound", "pound").toFixed(2);
				document.getElementById("yenPound").innerHTML = currencyRate("yen", "pound").toFixed(2);
				document.getElementById("unadjustedYen").innerHTML = exchangeRates["yen"].toFixed(2);
				document.getElementById("euroYen").innerHTML = currencyRate("euro", "yen").toFixed(2);
				document.getElementById("dollarYen").innerHTML = currencyRate("dollar", "yen").toFixed(2);
				document.getElementById("poundYen").innerHTML = currencyRate("pound", "yen").toFixed(2);
				document.getElementById("yenYen").innerHTML = currencyRate("yen", "yen").toFixed(2);
			}

			function buyStocks() {
				var buyCount = Number.parseInt(document.getElementById("buyCount").value);
				if (money >= currentCost * buyCount) {
					money -= currentCost * buyCount;
					stocks += buyCount;
				} else {
					flash("notEnoughMoney");
				}
				updateDisplay();
				save();
			}

			function sellStocks() {
				var sellCount = Number.parseInt(document.getElementById("sellCount").value);
				if (stocks >= sellCount) {
					stocks -= sellCount;
					money += currentCost * sellCount;
				} else {
					flash("outOfStocks");
				}
				updateDisplay();
				save();
			}

			function buySellKeyPress(event) {
				switch (event.keyCode) {
					case 90:
					buyStocks();
					break;
					case 88:
					sellStocks();
					break;
				}
			}
		</script>
	</head>
	<body onload="init()">
		<h1>
			Stocks: Business is Booming
		</h1>
		<div>
			<h2 style="display:inline;">
				Z to buy
			</h2>
			<input type="number" value="1" id="buyCount">
			<h2 style="display:inline;">
				, X to sell
			</h2>
			<input type="number" value="1" id="sellCount">
			<h3 id="moneyDisplay">
				Money: €500
			</h3>
		</div>
		<div>
			<h3 id="stocksDisplay">
				Stocks: 1
			</h3>
			<h3 id="notEnoughMoney" style="color:red;display:none;">
				Not enough cash!
			</h3>
			<h3 id="outOfStocks" style="color:red;display:none;">
				Out of stocks!
			</h3>
			<h3 id="gameLoaded" style="color:green;display:none">
				Game loaded!  
			</h3>
		</div>
		<h2>
			Stock graph:
		</h2>
		<canvas id="graph" height="600" width="900">
			This doesn't work in Internet Explorer. Please get a real browser - Chrome, Firefox, Opera, Midori, or even Safari.
		</canvas>
		<h2>
			Currency exchange:
		</h2>
		<div>
			<table style="">
				<caption>Currency conversion table</caption>
				<tr>
					<th>Currency</th>
					<th>Unadjusted values</th>
					<th>1 Euro</th>
					<th>1 Dollar</th>
					<th>1 Pound</th>
					<th>1 Yen</th>
				</tr>
				<tr>
					<td>Euro</td>
					<td id="unadjustedEuro"></td>
					<td id="euroEuro"></td>
					<td id="dollarEuro"></td>
					<td id="poundEuro"></td>
					<td id="yenEuro"></td>
				</tr>
				<tr>
					<td>Dollar</td>
					<td id="unadjustedDollar"></td>
					<td id="euroDollar"></td>
					<td id="dollarDollar"></td>
					<td id="poundDollar"></td>
					<td id="yenDollar"></td>
				</tr>
				<tr>
					<td>Pound</td>
					<td id="unadjustedPound"></td>
					<td id="euroPound"></td>
					<td id="dollarPound"></td>
					<td id="poundPound"></td>
					<td id="yenPound"></td>
				</tr>
				<tr>
					<td>Yen</td>
					<td id="unadjustedYen"></td>
					<td id="euroYen"></td>
					<td id="dollarYen"></td>
					<td id="poundYen"></td>
					<td id="yenYen"></td>
				</tr>
			</table>
			<p>
				<button id="toEuro" onclick="convertToCurrency('euro')">
					Convert to Euros. Current exchange rate: €1 = €1
				</button>
				<button id="toDollar" onclick="convertToCurrency('dollar')">
					Convert to Dollars. Current exchange rate: €1 = $1
				</button>
				<button id="toPound" onclick="convertToCurrency('pound')">
					Convert to Pounds. Current exchange rate: €1 = ‎£1
				</button>
				<button id="toYen" onclick="convertToCurrency('yen')">
					Convert to Yen. Current exchange rate: €1 = ‎¥1
				</button>
			</p>
		</div>
		<div>
			<a href="https://github.com/Aearnus/aearnus.github.io/commits/master/stocks">
				Here's the update log
			</a>
		</div>
		<br><br><br><br><br><br><br>
		<button onclick="localStorage.clear();window.location=window.location">
			Reset completely (for dev purposes)
		</button>
	</body>
</html>